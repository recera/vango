---
title: Router Code-Generation Spec
slug: codegen-routing-spec
version: 0.2
status: draft
requires:
  - routing
---

# Routing Code-Gen – Inputs & Outputs

> **Audience**: Engineers writing `internal/cmd/router-gen`.

## 1. Inputs
* Glob pattern: `app/routes/**/*.go` excluding test files.  
* File path encodes params:
  * `[slug].go` → `slug string` (default `string`).
  * `[id:int].go` → `id int` (supported types: `string`, `int`, `int64`, `uuid.UUID`).
  * `[...rest].go` → catch-all `rest []string`.

## 2. Output Files
| File | Purpose |
|------|---------|
| `pkg/internal/router/tree_gen.go` | Radix tree `match(path string) handlerIdx` |
| `router/params.go` | `type BlogParams struct { Slug string }` + parse helpers |
| `router/paths.go` | `func Blog(slug string) string { return "/blog/"+slug }` |
| `router/table.json` | JSON lookup used by WASM side to rebuild tree |

All generated files include `// Code generated by vango; DO NOT EDIT.`

## 3. Radix Tree Algorithm
* Node struct: `{segment string, param bool, catchAll bool, idx int, children []*Node}`.
* Time complexity: O(log n) average due to segment prefix compression.

## 4. Param Type Inference Rules
| Suffix | Type | Regex Used |
|--------|------|------------|
| (none) | `string` | `[^/]+` |
| `:int` | `int` | `[0-9]+` |
| `:int64` | `int64` | `[0-9]+` |
| `:uuid` | `uuid.UUID` | `[0-9a-f-]{36}` |

In Go code, generator converts string to type using:
```go
val, err := strconv.Atoi(raw)
```
or relevant helper.

## 5. Error Handling
* If path segment contains unsupported type suffix → compile error.
* Duplicate routes produce deterministic conflict error with both file paths.

## 6. Layout & Middleware Wiring
* For each directory `dir`, generator looks for `*_layout.go` & `*_middleware.go`.
* It wraps page handler with layout & middleware chain *at build time* to avoid runtime reflection.

## 7. CI Assertion
Running `vango dev` auto-runs generator and checks timestamps. `go:generate` tag embeds command for IDEs.

## 8. Changelog
| Date | Version | Notes |
|------|---------|-------|
|2025-08-05|0.1|Initial draft|
|2025-08-06|0.2|Add CLI usage, acceptance tests, cross refs|

## 9. Generator CLI Usage
```bash
# regenerate router after adding new file
vango gen router --print-stats
```
Flags:
* `--watch` – re-run on FS changes.
* `--json`  – emit JSON summary to stdout (consumed by IDE plugin).

Sample stats output:
```
Scanned 47 pages    62ms
Generated 8 param structs, 47 matcher nodes, 1,284 LoC  
```

## 10. Acceptance & Validation
| Check | Command | Expected |
|-------|---------|----------|
| Conflict Detection | `go test ./cmd/vango/internal/router -run TestDuplicate` | fails with clear error |
| Catch-all Overlap | `go test ./cmd/... -run TestCatchAllEdge` | PASS |
| Golden Files | `go test ./cmd/... -run TestGolden` | generated code matches `testdata/*.golden` |
| JSON Table | `jq 'length>0' router/table.json` | valid JSON |

## 11. Cross-References
* Routing blueprint: `@docs/blueprints/routing.md`
* Build system step 1: `@docs/blueprints/build-system.md#4-code-generation-steps`
